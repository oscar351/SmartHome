<!DOCTYPE html>
<html>
  <head>
    <title>Hello</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel='stylesheet' href='/stylesheets/main.css' />
    <link rel='stylesheet' href='/stylesheets/toggle-switchy.css' />
    <script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
  </head>
  <body>
    <div id="top-logo">
      <h1>Moble<br>SweetHome</h1>
    </div>
      <div id="logout">
      <p><%=name %>님 환영합니다!</o>
      <form action="/logout" id="lgbt">
        <button type="submit">로그아웃</button>
      </form>
      </div>
    <div id="container">
    <div id="left-btn">
      <div id="left-led">
      <div id="left-led-name">
        <p>조명</p>
      </div>
      <div id="left-led-data">
        <div id="section">
          <p>거실</p>
          <label class="toggle-switchy" for="example_default_1" data-size="xl">
            <input type="checkbox" id="example_default_1">
            <span class="toggle">
              <span class="switch"></span>
            </span>
        </div>
        <div id="section">
          <p>화장실</p>
          <label class="toggle-switchy" for="example_default_2" data-size="xl">
            <input type="checkbox" id="example_default_2">
            <span class="toggle">
              <span class="switch"></span>
            </span>
        </div>
        <div id="section">
          <p>방 1</p>
          <label class="toggle-switchy" for="example_default_3" data-size="xl">
            <input type="checkbox" id="example_default_3">
            <span class="toggle">
              <span class="switch"></span>
            </span>
        </div>
      </div>
    </div>
      <div id="left-fan">
        <div id="left-fan-name">
          <p>환풍기</p>
        </div>
        <div id="left-fan-data">
          <div id="section">
            <input type="image" src="/stylesheets/image/fan_off.png" id="fanicon" disabled>
            <label class="toggle-switchy" for="example_default_4" data-size="xl">
              <input checked type="checkbox" id="example_default_4">
              <span class="toggle">
                <span class="switch"></span>
              </span>
            </label>
            <script type="text/javascript">
              $(document).ready(function(){
                if($('#example_default_4').prop('checked') == false){
                  $('#fanicon').attr('src','/stylesheets/image/fan_off.png');
                }else{
                  $('#fanicon').attr('src','/stylesheets/image/fan_on.png');
                }
              })

              $('#example_default_4').change(function(){
                if($('#example_default_4').prop('checked') == false){
                  $('#fanicon').attr('src','/stylesheets/image/fan_off.png');
                }else{
                  $('#fanicon').attr('src','/stylesheets/image/fan_on.png');
                }
              });
            </script>
          </div>
        </div>
      </div>
    </div>
    <div id="center-btn">
      <div id="center-camera">
      <div id="center-camera-name">
        <p>보안</p>
      </div>
      <div id="center-camera-data">
        <p>카메라 들어갈 곳</p>
      </div>
      </div>
    </div>
    <div id="right-btn">
      <div id="right-house">
        <p id="right-name">집</p>
        <div id="right-house-data">
          <div class="rhd"><p>온도 : </p><p>00</p><p class="unit">℃</p></div>
          <div class="rhd"><p>습도 : </p><p>00</p><p class="unit">%</p></div>
          <div class="rhd"><p>미세먼지 : </p><p>00</p><p class="unit">㎍/㎥</p></div>
        </div>
      </div>
      <div id="right-out">
        <p id="right-name">외부</p>
        <div id="right-out-data">
          <span class="js-weather"></span>
          <img class="weatherIcon">
        </div>
      </div>
      <script type="text/javascript">
        
        const weather = document.querySelector(".js-weather");
        const weatherIconImg = document.querySelector('.weatherIcon');

// coord : 좌표
const API_KEY = "37f61a5b1124dd4e1907e2c6c53f8298";
const COORDS = "coords";

// function saveCoords(coordsObj){
//     localStorage.setItem(COORDS, JSON.stringify(coordsObj));
// };

function getWeather(lat, lng){
    fetch(
        `http://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&appid=${API_KEY}&units=metric`
    ).then(function(response){
        return response.json();
    })
    .then(function(json){
        const temp = json.main.temp;
        const place = json.name;
        // 내가 더 추가해보기!
        const skyCondition = json.weather[0].main;
        const nation = json.sys.country;
        weather.innerText = `${skyCondition} ${temp} @${place} in ${nation}`;
        const weatherIcon = json.weather[0].icon;
        const weatherIconAdrs = `http://openweathermap.org/img/wn/${weatherIcon}@2x.png`;
        weatherIconImg.setAttribute('src', weatherIconAdrs);
    });
}

function handleGeoSuccess(position){
    const latitude = position.coords.latitude;
    const longitude = position.coords.longitude;
    // key와 value 변수명이 같다면! 아래와 같이 표현 가능
    const coordsObj = {
        latitude,
        longitude
    };
    // saveCoords(coordsObj);
    getWeather(latitude, longitude);
};

function handleGeoError(){
    console.log("Can not access geo location");
};

function askForCoords(){
  const options = {
        enableHighAccuracy: true, // 대략적인 값이라도 상관 없음: 기본값
        
        maximumAge: 0,

        timeout: 15000    // 15초 이상 기다리지 않는다.
    };

    navigator.geolocation.getCurrentPosition(handleGeoSuccess, handleGeoError, options);
};

function loadCoords(){
  const loadedcoords = localStorage.getItem(COORDS);
  if(loadedcoords === null){
      askForCoords();
    }else{
        //getWeather
        const parseCoords = JSON.parse(loadedcoords);
        getWeather(parseCoords.latitude, parseCoords.longitude);
    }
};

function init(){
    loadCoords();
};

init();
      </script>
    </div>
  </div>
  </body>
</html>
